<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>éŸ‹ä¼¯å·¥æ¥­å€ä½ç†è«–ï½œäº’å‹•æ•™å­¸</title>
  <style>
    :root{
      --bg:#0b0d10;--panel:#12161b;--ink:#e7edf3;--muted:#9fb2c7;--accent:#4cc9f0;--ok:#67e8f9;--warn:#fbbf24;--bad:#fb7185;
      --grid:#1f2937;--iso:#3b82f6;--labor:#eab308;--mat:#a78bfa;--cons:#34d399;--p:#f472b6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    body{margin:0;display:flex;flex-direction:column}
    header{padding:.8rem 1rem;border-bottom:1px solid #111;background:linear-gradient(180deg,#0d1116,#0b0d10)}
    header h1{font-size:clamp(1rem,2.5vw,1.35rem);margin:0;font-weight:700}
    header p{margin:.25rem 0 0;color:var(--muted);font-size:clamp(.8rem,2vw,.95rem)}

    .app{display:grid;grid-template-columns:1fr;gap:.75rem;padding:.75rem}
    @media(min-width:900px){
      .app{grid-template-columns: minmax(320px,480px) 1fr}
    }

    .panel{background:var(--panel);border:1px solid #111;border-radius:16px;padding:12px;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset}
    .panel h2{margin:.25rem 0 .5rem;font-size:1.05rem}
    .panel h3{margin:.75rem 0 .25rem;font-size:.95rem;color:var(--muted)}
    .panel .row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;margin:.35rem 0}
    .panel label{font-size:.9rem;color:var(--muted)}
    .panel input[type="range"]{width:100%}
    .panel .pill{display:inline-block;padding:.15rem .5rem;border:1px solid #22303c;border-radius:999px;color:var(--muted);font-size:.75rem}

    .legend{display:flex;flex-wrap:wrap;gap:.35rem}
    .legend span{display:inline-flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--muted)}
    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}

    .canvasWrap{position:relative;background:#0a0e13;border:1px solid #111;border-radius:16px;overflow:hidden;min-height:40vh}
    canvas{display:block;width:100%;height:100%;aspect-ratio:2532/1170; /* iPhone Pro Max portrait ratio */}

    .explain{line-height:1.35;color:#cdd9e5;font-size:.92rem}
    .explain p{margin:.4rem 0}
    .explain .ok{color:var(--ok)}
    .explain .bad{color:var(--bad)}
    .explain .warn{color:var(--warn)}

    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .toolbar button{background:#0f1420;border:1px solid #1f2a37;border-radius:10px;color:var(--ink);padding:.45rem .7rem;font-size:.9rem;cursor:pointer}
    .toolbar button:hover{border-color:#2a3a4a}

    .foot{padding:.25rem 1rem 1rem;color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <header>
    <h1>éŸ‹ä¼¯å·¥æ¥­å€ä½ç†è«–ï½œäº’å‹•æ•™å­¸ï¼ˆè¡Œå‹•è£ç½®å‹å–„ï¼‰</h1>
    <p>æ‹–æ›³åœ°åœ–ä¸Šçš„é»ã€èª¿æ•´æ»‘æ¡¿ï¼Œç«‹åˆ»çœ‹åˆ°ã€Œé‹è¼¸æœ€å°é» Pã€å¦‚ä½•æ”¹è®Šã€‚æ–°å¢äº†æ¸…æ¥šçš„åœ–ä¾‹èˆ‡å³æ™‚èªªæ˜ã€‚</p>
  </header>

  <div class="app">
    <!-- Controls & explanations -->
    <section class="panel" id="controls">
      <h2>æ§åˆ¶é¢æ¿</h2>
      <div class="legend" style="margin-bottom:.5rem">
        <span><i class="swatch" style="background:var(--mat)"></i>ææ–™å€‰åº« M1/M2</span>
        <span><i class="swatch" style="background:var(--cons)"></i>æ¶ˆè²»åœ° K</span>
        <span><i class="swatch" style="background:var(--labor)"></i>å‹å‹•åœ° Lï¼ˆå‹å‹•å ´æ‰€ï¼‰</span>
        <span><i class="swatch" style="background:var(--p)"></i>é‹è¼¸æœ€å°é» P / å¯¦éš›å€ä½</span>
        <span><i class="swatch" style="background:var(--iso)"></i>ç­‰è²»ç·šï¼ˆÎ”K ç›¸åŒï¼‰</span>
      </div>

      <h3>ææ–™æ¬Šé‡ï¼ˆæ¯å™¸ç”¢å“éœ€é‹å¤šå°‘è·é›¢ï¼‰</h3>
      <div class="row"><label>æ¬Šé‡ a1ï¼ˆM1ï¼‰ <span class="pill" id="a1Lab"></span></label><input id="a1" type="range" min="0" max="12" step="0.5" value="4"></div>
      <div class="row"><label>æ¬Šé‡ a2ï¼ˆM2ï¼‰ <span class="pill" id="a2Lab"></span></label><input id="a2" type="range" min="0" max="12" step="0.5" value="6"></div>
      <div class="row"><label>æ¬Šé‡ a3ï¼ˆæˆå“åˆ° Kï¼‰ <span class="pill" id="a3Lab"></span></label><input id="a3" type="range" min="0" max="12" step="0.5" value="3"></div>

      <h3>è²»ç‡èˆ‡å‹å‹•</h3>
      <div class="row"><label>æ¯å™¸å…¬é‡Œè²»ç‡ ğ’œâ‚› <span class="pill" id="rateLab"></span></label><input id="rate" type="range" min="0.01" max="0.2" step="0.005" value="0.05"></div>
      <div class="row"><label>å‹å‹•ç¯€ç´„ï¼ˆæ¯å™¸ï¼‰S <span class="pill" id="saveLab"></span></label><input id="save" type="range" min="0" max="120" step="2" value="20"></div>

      <h3>é¡¯ç¤º</h3>
      <div class="row"><label>é¡¯ç¤ºç†±åº¦é›²ï¼ˆÎ”Kï¼‰</label><input id="heat" type="checkbox" checked></div>
      <div class="row"><label>é¡¯ç¤ºç­‰è²»ç·š</label><input id="isoOn" type="checkbox" checked></div>
      <div class="row"><label>é¡¯ç¤ºã€Œå‹å‹•è‡¨ç•Œåœˆã€</label><input id="laborOn" type="checkbox" checked></div>

      <div class="toolbar">
        <button id="reset">é‡ç½®</button>
        <button id="selftest">è‡ªæª¢</button>
        <button id="png">åŒ¯å‡º PNG</button>
      </div>

      <div class="explain" id="explainBox" style="margin-top:.5rem"></div>
    </section>

    <!-- Canvas -->
    <section class="panel canvasWrap">
      <canvas id="c" width="1266" height="585"></canvas>
    </section>
  </div>

  <div class="foot">æç¤ºï¼šé»‘è‰²åŠé€æ˜çš„ã€Œé›²ã€ï¼æ¯”æœ€å°é‹è¼¸æˆæœ¬é«˜å‡ºçš„é¡å¤–æˆæœ¬ Î”Kï¼ˆè¶Šæ·±è¶Šè²´ï¼‰ã€‚é»ƒè‰²è™›ç·šåœˆï¼åœ¨æ­¤åœˆå…§ï¼Œè‹¥æŠŠå·¥å» æ¬å» Lï¼Œå‹å‹•ç¯€ç´„ S â‰¥ é¡å¤–é‹è¼¸æˆæœ¬ â‡’ ç”Ÿç”¢æœƒè½‰å¾€ Lã€‚</div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = id => document.getElementById(id);
    const canvas = el('c');
    const ctx = canvas.getContext('2d');

    // --- State -------------------------------------------------------------
    const state = {
      a1: 4, a2: 6, a3: 3, // weights
      rate: 0.05, // As
      save: 20,   // labor saving per ton
      showHeat: true,
      showIso: true,
      showLabor: true,
      // points in canvas coords
      M1: {x: canvas.width*0.22, y: canvas.height*0.75},
      M2: {x: canvas.width*0.78, y: canvas.height*0.72},
      K:  {x: canvas.width*0.55, y: canvas.height*0.20},
      L:  {x: canvas.width*0.28, y: canvas.height*0.28},
      dragging: null,
      Ptransport: {x:0,y:0},
      Peffective: {x:0,y:0},
      lastInfo: ''
    };

    // --- UI bindings ------------------------------------------------------
    const updPill = (id, txt) => el(id).textContent = txt;
    const fmt = n => (Math.abs(n) < 100 ? n.toFixed(2) : Math.round(n));

    function syncUI(){
      updPill('a1Lab', `a1 = ${fmt(state.a1)}`);
      updPill('a2Lab', `a2 = ${fmt(state.a2)}`);
      updPill('a3Lab', `a3 = ${fmt(state.a3)}`);
      updPill('rateLab', `${fmt(state.rate)} /å™¸Â·å…¬é‡Œ`);
      updPill('saveLab', `${fmt(state.save)} /å™¸`);
    }

    const sliders = ['a1','a2','a3','rate','save'];
    sliders.forEach(id=>{
      const s = el(id);
      s.addEventListener('input', ()=>{
        const v = parseFloat(s.value);
        state[id] = v; syncUI(); draw();
      });
    });
    el('heat').addEventListener('change', e=>{state.showHeat = e.target.checked; draw()});
    el('isoOn').addEventListener('change', e=>{state.showIso = e.target.checked; draw()});
    el('laborOn').addEventListener('change', e=>{state.showLabor = e.target.checked; draw()});

    el('reset').addEventListener('click', ()=>{
      state.a1=4; state.a2=6; state.a3=3; state.rate=0.05; state.save=20;
      state.M1={x: canvas.width*0.22, y: canvas.height*0.75};
      state.M2={x: canvas.width*0.78, y: canvas.height*0.72};
      state.K= {x: canvas.width*0.55, y: canvas.height*0.20};
      state.L= {x: canvas.width*0.28, y: canvas.height*0.28};
      el('heat').checked=true; el('isoOn').checked=true; el('laborOn').checked=true;
      syncUI(); draw();
    });

    el('png').addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = 'weber_tutorial.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    });

    el('selftest').addEventListener('click', ()=>{
      const msgs = [];
      // 1) å°ç¨±ã€ç­‰æ¬Šé‡ â‡’ P åœ¨ä¸‰è§’å½¢å¹¾ä½•ä¸­å¿ƒé™„è¿‘ï¼ˆè³ªå¿ƒè¿‘ä¼¼ï¼‰
      const backup = JSON.parse(JSON.stringify(state));
      state.M1={x:200,y:500}; state.M2={x:1060,y:500}; state.K={x:630,y:120};
      state.a1=state.a2=state.a3=1; solveP();
      const centroid={x:(state.M1.x+state.M2.x+state.K.x)/3,y:(state.M1.y+state.M2.y+state.K.y)/3};
      const d1 = dist(state.Ptransport, centroid);
      msgs.push(d1<5? 'âœ“ å°ç¨±æƒ…å½¢ï¼šP æ¥è¿‘è³ªå¿ƒ':'âœ— å°ç¨±æƒ…å½¢æœªé€šé');
      // 2) a1 æ¥µå¤§ â‡’ P è²¼è¿‘ M1
      state.a1=100; state.a2=1; state.a3=1; solveP();
      const d2 = dist(state.Ptransport, state.M1);
      msgs.push(d2<3? 'âœ“ é‡æ¬Šé‡ï¼šP é è¿‘ M1':'âœ— é‡æ¬Šé‡æœªé€šé');
      // 3) å‹å‹•ç¯€ç´„å¤§ â‡’ å¯¦éš›å€ä½è½‰å‘ L
      state.a1=state.a2=state.a3=5; state.rate=0.05; state.save=1e6; state.L={x:500,y:300};
      solveP(); applyLabor();
      msgs.push(eqPt(state.Peffective,state.L,1)? 'âœ“ é«˜å‹å‹•ç¯€ç´„ï¼šè½‰å‘ L':'âœ— å‹å‹•ç¯€ç´„æœªè½‰å‘');
      // æ¢å¾©
      Object.assign(state, backup);
      syncUI(); draw();
      alert(msgs.join('\n'));
    });

    // --- Geometry helpers -------------------------------------------------
    const dist = (p,q)=> Math.hypot(p.x-q.x,p.y-q.y);
    const lerp = (a,b,t)=> a+(b-a)*t;
    function eqPt(p,q,eps){return dist(p,q)<= (eps??1.5)}

    // --- Cost model --------------------------------------------------------
    function K(p){
      const {a1,a2,a3,rate,M1,M2,K} = state;
      const sum = a1*dist(p,M1) + a2*dist(p,M2) + a3*dist(p,K);
      return sum * rate; // é‡‘é¡/å™¸
    }

    // Weiszfeldï¼ˆå¸¶æ¬Šé‡ï¼‰
    function solveP(){
      const {M1,M2,K} = state;
      let x = (M1.x+M2.x+K.x)/3, y=(M1.y+M2.y+K.y)/3;
      for(let iter=0; iter<200; iter++){
        const pts=[M1,M2,K]; const ws=[state.a1,state.a2,state.a3];
        let numX=0,numY=0,den=0; let snap=null;
        for(let i=0;i<3;i++){
          const d = Math.hypot(x-pts[i].x,y-pts[i].y);
          if(d<1e-6){ snap=pts[i]; break; }
          const w = ws[i]/d; numX += w*pts[i].x; numY += w*pts[i].y; den += w;
        }
        if(snap){ x=snap.x; y=snap.y; break; }
        const nx = numX/den, ny=numY/den;
        if(Math.hypot(nx-x,ny-y)<0.1){ x=nx; y=ny; break; }
        x=nx; y=ny;
      }
      state.Ptransport = {x,y};
    }

    function applyLabor(){
      const {save,L} = state;
      const dK = K(L) - K(state.Ptransport); // åå·®æˆæœ¬ï¼ˆæ¯å™¸ï¼‰
      if(save >= dK){
        state.Peffective = {...L};
        state.lastInfo = `å‹å‹•ç¯€ç´„ S = ${fmt(save)} â‰¥ åå·®æˆæœ¬ Î”K(L) = ${fmt(dK)} â†’ ç”Ÿç”¢è½‰å‘ Lã€‚`;
      }else{
        state.Peffective = {...state.Ptransport};
        state.lastInfo = `å‹å‹•ç¯€ç´„ S = ${fmt(save)} < åå·®æˆæœ¬ Î”K(L) = ${fmt(dK)} â†’ ä»ç•™åœ¨é‹è¼¸æœ€å°é» Pã€‚`;
      }
      return {dK};
    }

    // è¿‘ä¼¼ã€Œè‡¨ç•Œç­‰è²»ç·šã€ï¼šè§£ Î”K(r,Î¸) = Sï¼Œæ²¿å„è§’åº¦äºŒåˆ†æœå°‹åŠå¾‘
    function criticalIsodapane(points=96){
      const pts=[]; const S = state.save; const P0 = state.Ptransport;
      const K0 = K(P0);
      for(let i=0;i<points;i++){
        const th = i/points*2*Math.PI;
        let lo=0, hi=Math.hypot(canvas.width,canvas.height);
        for(let it=0; it<16; it++){
          const mid=(lo+hi)/2;
          const p = {x:P0.x+Math.cos(th)*mid, y:P0.y+Math.sin(th)*mid};
          const dK = K(p)-K0;
          if(dK<S) lo=mid; else hi=mid;
        }
        const r=hi; pts.push({x:P0.x+Math.cos(th)*r, y:P0.y+Math.sin(th)*r});
      }
      return pts;
    }

    // --- Rendering --------------------------------------------------------
    function draw(){
      solveP();
      const {dK} = applyLabor();
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // èƒŒæ™¯æ ¼
      ctx.save();
      ctx.strokeStyle = '#13202d'; ctx.lineWidth=1;
      for(let x=0;x<canvas.width;x+=48){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
      for(let y=0;y<canvas.height;y+=48){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
      ctx.restore();

      // ç†±åº¦é›²ï¼šÎ”Kï¼ˆç›¸å° Ptransportï¼‰
      if(state.showHeat){
        const K0 = K(state.Ptransport);
        const cell=6; // è¡Œå‹•è£ç½®ä¹Ÿé †
        const img = ctx.createImageData(canvas.width,canvas.height);
        for(let y=0;y<canvas.height;y+=cell){
          for(let x=0;x<canvas.width;x+=cell){
            const dKloc = K({x,y}) - K0; // æ¯å™¸é¡å¤–æˆæœ¬
            // map 0..max to alpha; clamp at 120/å™¸ï¼ˆèˆ‡ save ä¸Šé™å°é½Šï¼‰
            const alpha = Math.max(0, Math.min(1, dKloc/120));
            const shade = 0; // é»‘é›²
            for(let yy=0; yy<cell; yy++){
              for(let xx=0; xx<cell; xx++){
                const idx = 4*((y+yy)*canvas.width + (x+xx));
                img.data[idx+0]=shade;
                img.data[idx+1]=shade;
                img.data[idx+2]=shade;
                img.data[idx+3]=alpha*180; // é€æ˜åº¦
              }
            }
          }
        }
        ctx.putImageData(img,0,0);
      }

      // ç­‰è²»ç·šï¼šä»¥ Î”K = 10, 20, ..., 100 ç•«è¿‘ä¼¼ç­‰é«˜ç·šï¼ˆæ¡æ¨£ï¼‰
      if(state.showIso){
        const K0 = K(state.Ptransport);
        const steps = [10,20,30,40,60,80,100];
        ctx.save(); ctx.strokeStyle='rgba(59,130,246,.8)'; ctx.lineWidth=1.25;
        for(const S of steps){
          const poly = sampleIsodapan(S,K0,72);
          strokePoly(poly);
        }
        ctx.restore();
      }

      // å‹å‹•è‡¨ç•Œåœˆï¼ˆSï¼‰
      if(state.showLabor){
        const circ = criticalIsodapane(96);
        ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(234,179,8,.9)'; ctx.lineWidth=2;
        strokePoly(circ,true);
        ctx.restore();
      }

      // é€£ç·šä¸‰è§’å½¢
      line(state.M1,state.M2,'#22394d'); line(state.M2,state.K,'#22394d'); line(state.K,state.M1,'#22394d');

      // é»ä½èˆ‡æ¨™ç±¤
      dot(state.M1, 'M1', getCSS('--mat'));
      dot(state.M2, 'M2', getCSS('--mat'));
      dot(state.K,  'K',  getCSS('--cons'));
      dot(state.L,  'L',  getCSS('--labor'));

      // Pï¼ˆé‹è¼¸æœ€å°ï¼‰
      dot(state.Ptransport, 'Pâ‚€', getCSS('--p'));
      // å¯¦éš›å€ä½ï¼ˆè€ƒæ…®å‹å‹•ï¼‰
      ctx.save();
      ctx.beginPath(); ctx.arc(state.Peffective.x, state.Peffective.y, 7, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(244,114,182,.15)'; ctx.fill();
      ctx.strokeStyle = getCSS('--p'); ctx.lineWidth=2; ctx.stroke();
      ctx.restore(); label(state.Peffective, 'å¯¦éš›å€ä½', getCSS('--p'));

      // èªªæ˜ç›’
      const G = state.a1+state.a2+state.a3;
      const txt = [
        `ç›®å‰ï¼šaâ‚=${fmt(state.a1)}, aâ‚‚=${fmt(state.a2)}, aâ‚ƒ=${fmt(state.a3)}, ğ’œâ‚›=${fmt(state.rate)}, S=${fmt(state.save)}`,
        `é»‘è‰²é›²ï¼ç›¸å° Pâ‚€ çš„é¡å¤–é‹è¼¸æˆæœ¬ Î”Kã€‚è¶Šé»‘ï¼æ¯å™¸è¶Šè²´ï¼ˆä¸Šé™ 120ï¼‰ã€‚`,
        state.lastInfo,
        `ç›´è¦ºï¼šå¢å¤§æŸä¸€ææ–™æ¬Šé‡ â‡’ ç­‰è²»ç·šå‘è©²ææ–™å‚¾æ–œï¼ŒPâ‚€æœƒå‘è©²ææ–™ç§»å‹•ï¼›æé«˜ S â‡’ é»ƒè‰²åœˆæ“´å¤§ï¼Œè¼ƒå®¹æ˜“æ»¿è¶³ã€è½‰å¾€ Lã€æ¢ä»¶ã€‚`,
      ].join('<br>');
      el('explainBox').innerHTML = txt;
    }

    function sampleIsodapan(S, K0, rays){
      const P0 = state.Ptransport; const pts=[];
      for(let i=0;i<rays;i++){
        const th = i/rays*2*Math.PI;
        let lo=0, hi=Math.hypot(canvas.width,canvas.height);
        for(let it=0; it<16; it++){
          const mid=(lo+hi)/2;
          const p={x:P0.x+Math.cos(th)*mid, y:P0.y+Math.sin(th)*mid};
          const dK = K(p)-K0;
          if(dK<S) lo=mid; else hi=mid;
        }
        pts.push({x:P0.x+Math.cos(th)*hi, y:P0.y+Math.sin(th)*hi});
      }
      return pts;
    }

    function strokePoly(pts, close=true){
      if(!pts || pts.length<2) return;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      if(close) ctx.closePath(); ctx.stroke();
    }

    function getCSS(varName){return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();}
    function line(p,q,color){ctx.save();ctx.strokeStyle=color;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(q.x,q.y);ctx.stroke();ctx.restore();}
    function label(p, text, color){ctx.save();ctx.fillStyle=color;ctx.font='12px ui-sans-serif,system-ui';ctx.fillText(text, p.x+8, p.y-8);ctx.restore();}
    function dot(p, text, color){ctx.save();ctx.fillStyle=color;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();ctx.restore(); label(p,text,color)}

    // --- Dragging ---------------------------------------------------------
    const hitRadius = 14;
    function pick(mx,my){
      const keys=['M1','M2','K','L'];
      for(const k of keys){ if(dist({x:mx,y:my}, state[k])<hitRadius) return k; }
      return null;
    }
    canvas.addEventListener('pointerdown', e=>{
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX-rect.left)*canvas.width/rect.width;
      const y=(e.clientY-rect.top)*canvas.height/rect.height;
      state.dragging = pick(x,y);
    });
    canvas.addEventListener('pointermove', e=>{
      if(!state.dragging) return;
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX-rect.left)*canvas.width/rect.width;
      const y=(e.clientY-rect.top)*canvas.height/rect.height;
      state[state.dragging]={x,y}; draw();
    });
    canvas.addEventListener('pointerup', ()=> state.dragging=null);
    canvas.addEventListener('pointerleave', ()=> state.dragging=null);

    // --- Init -------------------------------------------------------------
    syncUI(); draw();
  });
  </script>
</body>
</html><!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>éŸ‹ä¼¯å·¥æ¥­å€ä½ç†è«–ï½œäº’å‹•æ•™å­¸</title>
  <style>
    :root{
      --bg:#0b0d10;--panel:#12161b;--ink:#e7edf3;--muted:#9fb2c7;--accent:#4cc9f0;--ok:#67e8f9;--warn:#fbbf24;--bad:#fb7185;
      --grid:#1f2937;--iso:#3b82f6;--labor:#eab308;--mat:#a78bfa;--cons:#34d399;--p:#f472b6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    body{margin:0;display:flex;flex-direction:column}
    header{padding:.8rem 1rem;border-bottom:1px solid #111;background:linear-gradient(180deg,#0d1116,#0b0d10)}
    header h1{font-size:clamp(1rem,2.5vw,1.35rem);margin:0;font-weight:700}
    header p{margin:.25rem 0 0;color:var(--muted);font-size:clamp(.8rem,2vw,.95rem)}

    .app{display:grid;grid-template-columns:1fr;gap:.75rem;padding:.75rem}
    @media(min-width:900px){
      .app{grid-template-columns: minmax(320px,480px) 1fr}
    }

    .panel{background:var(--panel);border:1px solid #111;border-radius:16px;padding:12px;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset}
    .panel h2{margin:.25rem 0 .5rem;font-size:1.05rem}
    .panel h3{margin:.75rem 0 .25rem;font-size:.95rem;color:var(--muted)}
    .panel .row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;margin:.35rem 0}
    .panel label{font-size:.9rem;color:var(--muted)}
    .panel input[type="range"]{width:100%}
    .panel .pill{display:inline-block;padding:.15rem .5rem;border:1px solid #22303c;border-radius:999px;color:var(--muted);font-size:.75rem}

    .legend{display:flex;flex-wrap:wrap;gap:.35rem}
    .legend span{display:inline-flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--muted)}
    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}

    .canvasWrap{position:relative;background:#0a0e13;border:1px solid #111;border-radius:16px;overflow:hidden;min-height:40vh}
    canvas{display:block;width:100%;height:100%;aspect-ratio:2532/1170; /* iPhone Pro Max portrait ratio */}

    .explain{line-height:1.35;color:#cdd9e5;font-size:.92rem}
    .explain p{margin:.4rem 0}
    .explain .ok{color:var(--ok)}
    .explain .bad{color:var(--bad)}
    .explain .warn{color:var(--warn)}

    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .toolbar button{background:#0f1420;border:1px solid #1f2a37;border-radius:10px;color:var(--ink);padding:.45rem .7rem;font-size:.9rem;cursor:pointer}
    .toolbar button:hover{border-color:#2a3a4a}

    .foot{padding:.25rem 1rem 1rem;color:var(--muted);font-size:.8rem}
  </style>
</head>
<body>
  <header>
    <h1>éŸ‹ä¼¯å·¥æ¥­å€ä½ç†è«–ï½œäº’å‹•æ•™å­¸ï¼ˆè¡Œå‹•è£ç½®å‹å–„ï¼‰</h1>
    <p>æ‹–æ›³åœ°åœ–ä¸Šçš„é»ã€èª¿æ•´æ»‘æ¡¿ï¼Œç«‹åˆ»çœ‹åˆ°ã€Œé‹è¼¸æœ€å°é» Pã€å¦‚ä½•æ”¹è®Šã€‚æ–°å¢äº†æ¸…æ¥šçš„åœ–ä¾‹èˆ‡å³æ™‚èªªæ˜ã€‚</p>
  </header>

  <div class="app">
    <!-- Controls & explanations -->
    <section class="panel" id="controls">
      <h2>æ§åˆ¶é¢æ¿</h2>
      <div class="legend" style="margin-bottom:.5rem">
        <span><i class="swatch" style="background:var(--mat)"></i>ææ–™å€‰åº« M1/M2</span>
        <span><i class="swatch" style="background:var(--cons)"></i>æ¶ˆè²»åœ° K</span>
        <span><i class="swatch" style="background:var(--labor)"></i>å‹å‹•åœ° Lï¼ˆå‹å‹•å ´æ‰€ï¼‰</span>
        <span><i class="swatch" style="background:var(--p)"></i>é‹è¼¸æœ€å°é» P / å¯¦éš›å€ä½</span>
        <span><i class="swatch" style="background:var(--iso)"></i>ç­‰è²»ç·šï¼ˆÎ”K ç›¸åŒï¼‰</span>
      </div>

      <h3>ææ–™æ¬Šé‡ï¼ˆæ¯å™¸ç”¢å“éœ€é‹å¤šå°‘è·é›¢ï¼‰</h3>
      <div class="row"><label>æ¬Šé‡ a1ï¼ˆM1ï¼‰ <span class="pill" id="a1Lab"></span></label><input id="a1" type="range" min="0" max="12" step="0.5" value="4"></div>
      <div class="row"><label>æ¬Šé‡ a2ï¼ˆM2ï¼‰ <span class="pill" id="a2Lab"></span></label><input id="a2" type="range" min="0" max="12" step="0.5" value="6"></div>
      <div class="row"><label>æ¬Šé‡ a3ï¼ˆæˆå“åˆ° Kï¼‰ <span class="pill" id="a3Lab"></span></label><input id="a3" type="range" min="0" max="12" step="0.5" value="3"></div>

      <h3>è²»ç‡èˆ‡å‹å‹•</h3>
      <div class="row"><label>æ¯å™¸å…¬é‡Œè²»ç‡ ğ’œâ‚› <span class="pill" id="rateLab"></span></label><input id="rate" type="range" min="0.01" max="0.2" step="0.005" value="0.05"></div>
      <div class="row"><label>å‹å‹•ç¯€ç´„ï¼ˆæ¯å™¸ï¼‰S <span class="pill" id="saveLab"></span></label><input id="save" type="range" min="0" max="120" step="2" value="20"></div>

      <h3>é¡¯ç¤º</h3>
      <div class="row"><label>é¡¯ç¤ºç†±åº¦é›²ï¼ˆÎ”Kï¼‰</label><input id="heat" type="checkbox" checked></div>
      <div class="row"><label>é¡¯ç¤ºç­‰è²»ç·š</label><input id="isoOn" type="checkbox" checked></div>
      <div class="row"><label>é¡¯ç¤ºã€Œå‹å‹•è‡¨ç•Œåœˆã€</label><input id="laborOn" type="checkbox" checked></div>

      <div class="toolbar">
        <button id="reset">é‡ç½®</button>
        <button id="selftest">è‡ªæª¢</button>
        <button id="png">åŒ¯å‡º PNG</button>
      </div>

      <div class="explain" id="explainBox" style="margin-top:.5rem"></div>
    </section>

    <!-- Canvas -->
    <section class="panel canvasWrap">
      <canvas id="c" width="1266" height="585"></canvas>
    </section>
  </div>

  <div class="foot">æç¤ºï¼šé»‘è‰²åŠé€æ˜çš„ã€Œé›²ã€ï¼æ¯”æœ€å°é‹è¼¸æˆæœ¬é«˜å‡ºçš„é¡å¤–æˆæœ¬ Î”Kï¼ˆè¶Šæ·±è¶Šè²´ï¼‰ã€‚é»ƒè‰²è™›ç·šåœˆï¼åœ¨æ­¤åœˆå…§ï¼Œè‹¥æŠŠå·¥å» æ¬å» Lï¼Œå‹å‹•ç¯€ç´„ S â‰¥ é¡å¤–é‹è¼¸æˆæœ¬ â‡’ ç”Ÿç”¢æœƒè½‰å¾€ Lã€‚</div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = id => document.getElementById(id);
    const canvas = el('c');
    const ctx = canvas.getContext('2d');

    // --- State -------------------------------------------------------------
    const state = {
      a1: 4, a2: 6, a3: 3, // weights
      rate: 0.05, // As
      save: 20,   // labor saving per ton
      showHeat: true,
      showIso: true,
      showLabor: true,
      // points in canvas coords
      M1: {x: canvas.width*0.22, y: canvas.height*0.75},
      M2: {x: canvas.width*0.78, y: canvas.height*0.72},
      K:  {x: canvas.width*0.55, y: canvas.height*0.20},
      L:  {x: canvas.width*0.28, y: canvas.height*0.28},
      dragging: null,
      Ptransport: {x:0,y:0},
      Peffective: {x:0,y:0},
      lastInfo: ''
    };

    // --- UI bindings ------------------------------------------------------
    const updPill = (id, txt) => el(id).textContent = txt;
    const fmt = n => (Math.abs(n) < 100 ? n.toFixed(2) : Math.round(n));

    function syncUI(){
      updPill('a1Lab', `a1 = ${fmt(state.a1)}`);
      updPill('a2Lab', `a2 = ${fmt(state.a2)}`);
      updPill('a3Lab', `a3 = ${fmt(state.a3)}`);
      updPill('rateLab', `${fmt(state.rate)} /å™¸Â·å…¬é‡Œ`);
      updPill('saveLab', `${fmt(state.save)} /å™¸`);
    }

    const sliders = ['a1','a2','a3','rate','save'];
    sliders.forEach(id=>{
      const s = el(id);
      s.addEventListener('input', ()=>{
        const v = parseFloat(s.value);
        state[id] = v; syncUI(); draw();
      });
    });
    el('heat').addEventListener('change', e=>{state.showHeat = e.target.checked; draw()});
    el('isoOn').addEventListener('change', e=>{state.showIso = e.target.checked; draw()});
    el('laborOn').addEventListener('change', e=>{state.showLabor = e.target.checked; draw()});

    el('reset').addEventListener('click', ()=>{
      state.a1=4; state.a2=6; state.a3=3; state.rate=0.05; state.save=20;
      state.M1={x: canvas.width*0.22, y: canvas.height*0.75};
      state.M2={x: canvas.width*0.78, y: canvas.height*0.72};
      state.K= {x: canvas.width*0.55, y: canvas.height*0.20};
      state.L= {x: canvas.width*0.28, y: canvas.height*0.28};
      el('heat').checked=true; el('isoOn').checked=true; el('laborOn').checked=true;
      syncUI(); draw();
    });

    el('png').addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = 'weber_tutorial.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    });

    el('selftest').addEventListener('click', ()=>{
      const msgs = [];
      // 1) å°ç¨±ã€ç­‰æ¬Šé‡ â‡’ P åœ¨ä¸‰è§’å½¢å¹¾ä½•ä¸­å¿ƒé™„è¿‘ï¼ˆè³ªå¿ƒè¿‘ä¼¼ï¼‰
      const backup = JSON.parse(JSON.stringify(state));
      state.M1={x:200,y:500}; state.M2={x:1060,y:500}; state.K={x:630,y:120};
      state.a1=state.a2=state.a3=1; solveP();
      const centroid={x:(state.M1.x+state.M2.x+state.K.x)/3,y:(state.M1.y+state.M2.y+state.K.y)/3};
      const d1 = dist(state.Ptransport, centroid);
      msgs.push(d1<5? 'âœ“ å°ç¨±æƒ…å½¢ï¼šP æ¥è¿‘è³ªå¿ƒ':'âœ— å°ç¨±æƒ…å½¢æœªé€šé');
      // 2) a1 æ¥µå¤§ â‡’ P è²¼è¿‘ M1
      state.a1=100; state.a2=1; state.a3=1; solveP();
      const d2 = dist(state.Ptransport, state.M1);
      msgs.push(d2<3? 'âœ“ é‡æ¬Šé‡ï¼šP é è¿‘ M1':'âœ— é‡æ¬Šé‡æœªé€šé');
      // 3) å‹å‹•ç¯€ç´„å¤§ â‡’ å¯¦éš›å€ä½è½‰å‘ L
      state.a1=state.a2=state.a3=5; state.rate=0.05; state.save=1e6; state.L={x:500,y:300};
      solveP(); applyLabor();
      msgs.push(eqPt(state.Peffective,state.L,1)? 'âœ“ é«˜å‹å‹•ç¯€ç´„ï¼šè½‰å‘ L':'âœ— å‹å‹•ç¯€ç´„æœªè½‰å‘');
      // æ¢å¾©
      Object.assign(state, backup);
      syncUI(); draw();
      alert(msgs.join('\n'));
    });

    // --- Geometry helpers -------------------------------------------------
    const dist = (p,q)=> Math.hypot(p.x-q.x,p.y-q.y);
    const lerp = (a,b,t)=> a+(b-a)*t;
    function eqPt(p,q,eps){return dist(p,q)<= (eps??1.5)}

    // --- Cost model --------------------------------------------------------
    function K(p){
      const {a1,a2,a3,rate,M1,M2,K} = state;
      const sum = a1*dist(p,M1) + a2*dist(p,M2) + a3*dist(p,K);
      return sum * rate; // é‡‘é¡/å™¸
    }

    // Weiszfeldï¼ˆå¸¶æ¬Šé‡ï¼‰
    function solveP(){
      const {M1,M2,K} = state;
      let x = (M1.x+M2.x+K.x)/3, y=(M1.y+M2.y+K.y)/3;
      for(let iter=0; iter<200; iter++){
        const pts=[M1,M2,K]; const ws=[state.a1,state.a2,state.a3];
        let numX=0,numY=0,den=0; let snap=null;
        for(let i=0;i<3;i++){
          const d = Math.hypot(x-pts[i].x,y-pts[i].y);
          if(d<1e-6){ snap=pts[i]; break; }
          const w = ws[i]/d; numX += w*pts[i].x; numY += w*pts[i].y; den += w;
        }
        if(snap){ x=snap.x; y=snap.y; break; }
        const nx = numX/den, ny=numY/den;
        if(Math.hypot(nx-x,ny-y)<0.1){ x=nx; y=ny; break; }
        x=nx; y=ny;
      }
      state.Ptransport = {x,y};
    }

    function applyLabor(){
      const {save,L} = state;
      const dK = K(L) - K(state.Ptransport); // åå·®æˆæœ¬ï¼ˆæ¯å™¸ï¼‰
      if(save >= dK){
        state.Peffective = {...L};
        state.lastInfo = `å‹å‹•ç¯€ç´„ S = ${fmt(save)} â‰¥ åå·®æˆæœ¬ Î”K(L) = ${fmt(dK)} â†’ ç”Ÿç”¢è½‰å‘ Lã€‚`;
      }else{
        state.Peffective = {...state.Ptransport};
        state.lastInfo = `å‹å‹•ç¯€ç´„ S = ${fmt(save)} < åå·®æˆæœ¬ Î”K(L) = ${fmt(dK)} â†’ ä»ç•™åœ¨é‹è¼¸æœ€å°é» Pã€‚`;
      }
      return {dK};
    }

    // è¿‘ä¼¼ã€Œè‡¨ç•Œç­‰è²»ç·šã€ï¼šè§£ Î”K(r,Î¸) = Sï¼Œæ²¿å„è§’åº¦äºŒåˆ†æœå°‹åŠå¾‘
    function criticalIsodapane(points=96){
      const pts=[]; const S = state.save; const P0 = state.Ptransport;
      const K0 = K(P0);
      for(let i=0;i<points;i++){
        const th = i/points*2*Math.PI;
        let lo=0, hi=Math.hypot(canvas.width,canvas.height);
        for(let it=0; it<16; it++){
          const mid=(lo+hi)/2;
          const p = {x:P0.x+Math.cos(th)*mid, y:P0.y+Math.sin(th)*mid};
          const dK = K(p)-K0;
          if(dK<S) lo=mid; else hi=mid;
        }
        const r=hi; pts.push({x:P0.x+Math.cos(th)*r, y:P0.y+Math.sin(th)*r});
      }
      return pts;
    }

    // --- Rendering --------------------------------------------------------
    function draw(){
      solveP();
      const {dK} = applyLabor();
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // èƒŒæ™¯æ ¼
      ctx.save();
      ctx.strokeStyle = '#13202d'; ctx.lineWidth=1;
      for(let x=0;x<canvas.width;x+=48){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
      for(let y=0;y<canvas.height;y+=48){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
      ctx.restore();

      // ç†±åº¦é›²ï¼šÎ”Kï¼ˆç›¸å° Ptransportï¼‰
      if(state.showHeat){
        const K0 = K(state.Ptransport);
        const cell=6; // è¡Œå‹•è£ç½®ä¹Ÿé †
        const img = ctx.createImageData(canvas.width,canvas.height);
        for(let y=0;y<canvas.height;y+=cell){
          for(let x=0;x<canvas.width;x+=cell){
            const dKloc = K({x,y}) - K0; // æ¯å™¸é¡å¤–æˆæœ¬
            // map 0..max to alpha; clamp at 120/å™¸ï¼ˆèˆ‡ save ä¸Šé™å°é½Šï¼‰
            const alpha = Math.max(0, Math.min(1, dKloc/120));
            const shade = 0; // é»‘é›²
            for(let yy=0; yy<cell; yy++){
              for(let xx=0; xx<cell; xx++){
                const idx = 4*((y+yy)*canvas.width + (x+xx));
                img.data[idx+0]=shade;
                img.data[idx+1]=shade;
                img.data[idx+2]=shade;
                img.data[idx+3]=alpha*180; // é€æ˜åº¦
              }
            }
          }
        }
        ctx.putImageData(img,0,0);
      }

      // ç­‰è²»ç·šï¼šä»¥ Î”K = 10, 20, ..., 100 ç•«è¿‘ä¼¼ç­‰é«˜ç·šï¼ˆæ¡æ¨£ï¼‰
      if(state.showIso){
        const K0 = K(state.Ptransport);
        const steps = [10,20,30,40,60,80,100];
        ctx.save(); ctx.strokeStyle='rgba(59,130,246,.8)'; ctx.lineWidth=1.25;
        for(const S of steps){
          const poly = sampleIsodapan(S,K0,72);
          strokePoly(poly);
        }
        ctx.restore();
      }

      // å‹å‹•è‡¨ç•Œåœˆï¼ˆSï¼‰
      if(state.showLabor){
        const circ = criticalIsodapane(96);
        ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(234,179,8,.9)'; ctx.lineWidth=2;
        strokePoly(circ,true);
        ctx.restore();
      }

      // é€£ç·šä¸‰è§’å½¢
      line(state.M1,state.M2,'#22394d'); line(state.M2,state.K,'#22394d'); line(state.K,state.M1,'#22394d');

      // é»ä½èˆ‡æ¨™ç±¤
      dot(state.M1, 'M1', getCSS('--mat'));
      dot(state.M2, 'M2', getCSS('--mat'));
      dot(state.K,  'K',  getCSS('--cons'));
      dot(state.L,  'L',  getCSS('--labor'));

      // Pï¼ˆé‹è¼¸æœ€å°ï¼‰
      dot(state.Ptransport, 'Pâ‚€', getCSS('--p'));
      // å¯¦éš›å€ä½ï¼ˆè€ƒæ…®å‹å‹•ï¼‰
      ctx.save();
      ctx.beginPath(); ctx.arc(state.Peffective.x, state.Peffective.y, 7, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(244,114,182,.15)'; ctx.fill();
      ctx.strokeStyle = getCSS('--p'); ctx.lineWidth=2; ctx.stroke();
      ctx.restore(); label(state.Peffective, 'å¯¦éš›å€ä½', getCSS('--p'));

      // èªªæ˜ç›’
      const G = state.a1+state.a2+state.a3;
      const txt = [
        `ç›®å‰ï¼šaâ‚=${fmt(state.a1)}, aâ‚‚=${fmt(state.a2)}, aâ‚ƒ=${fmt(state.a3)}, ğ’œâ‚›=${fmt(state.rate)}, S=${fmt(state.save)}`,
        `é»‘è‰²é›²ï¼ç›¸å° Pâ‚€ çš„é¡å¤–é‹è¼¸æˆæœ¬ Î”Kã€‚è¶Šé»‘ï¼æ¯å™¸è¶Šè²´ï¼ˆä¸Šé™ 120ï¼‰ã€‚`,
        state.lastInfo,
        `ç›´è¦ºï¼šå¢å¤§æŸä¸€ææ–™æ¬Šé‡ â‡’ ç­‰è²»ç·šå‘è©²ææ–™å‚¾æ–œï¼ŒPâ‚€æœƒå‘è©²ææ–™ç§»å‹•ï¼›æé«˜ S â‡’ é»ƒè‰²åœˆæ“´å¤§ï¼Œè¼ƒå®¹æ˜“æ»¿è¶³ã€è½‰å¾€ Lã€æ¢ä»¶ã€‚`,
      ].join('<br>');
      el('explainBox').innerHTML = txt;
    }

    function sampleIsodapan(S, K0, rays){
      const P0 = state.Ptransport; const pts=[];
      for(let i=0;i<rays;i++){
        const th = i/rays*2*Math.PI;
        let lo=0, hi=Math.hypot(canvas.width,canvas.height);
        for(let it=0; it<16; it++){
          const mid=(lo+hi)/2;
          const p={x:P0.x+Math.cos(th)*mid, y:P0.y+Math.sin(th)*mid};
          const dK = K(p)-K0;
          if(dK<S) lo=mid; else hi=mid;
        }
        pts.push({x:P0.x+Math.cos(th)*hi, y:P0.y+Math.sin(th)*hi});
      }
      return pts;
    }

    function strokePoly(pts, close=true){
      if(!pts || pts.length<2) return;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      if(close) ctx.closePath(); ctx.stroke();
    }

    function getCSS(varName){return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();}
    function line(p,q,color){ctx.save();ctx.strokeStyle=color;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(q.x,q.y);ctx.stroke();ctx.restore();}
    function label(p, text, color){ctx.save();ctx.fillStyle=color;ctx.font='12px ui-sans-serif,system-ui';ctx.fillText(text, p.x+8, p.y-8);ctx.restore();}
    function dot(p, text, color){ctx.save();ctx.fillStyle=color;ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();ctx.restore(); label(p,text,color)}

    // --- Dragging ---------------------------------------------------------
    const hitRadius = 14;
    function pick(mx,my){
      const keys=['M1','M2','K','L'];
      for(const k of keys){ if(dist({x:mx,y:my}, state[k])<hitRadius) return k; }
      return null;
    }
    canvas.addEventListener('pointerdown', e=>{
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX-rect.left)*canvas.width/rect.width;
      const y=(e.clientY-rect.top)*canvas.height/rect.height;
      state.dragging = pick(x,y);
    });
    canvas.addEventListener('pointermove', e=>{
      if(!state.dragging) return;
      const rect=canvas.getBoundingClientRect();
      const x=(e.clientX-rect.left)*canvas.width/rect.width;
      const y=(e.clientY-rect.top)*canvas.height/rect.height;
      state[state.dragging]={x,y}; draw();
    });
    canvas.addEventListener('pointerup', ()=> state.dragging=null);
    canvas.addEventListener('pointerleave', ()=> state.dragging=null);

    // --- Init -------------------------------------------------------------
    syncUI(); draw();
  });
  </script>
</body>
</html>