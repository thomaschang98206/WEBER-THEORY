<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>韋伯工業區位理論｜互動教學（正統判斷版）</title>
<style>
  :root{
    --bg:#0e1621;
    --panel:#121c29;
    --chip:#192436;
    --fg:#dbe7ff;
    --muted:#9fb3d9;
    --accent:#4ea1ff;
    --good:#3ddc97;
    --warn:#ffc857;
    --bad:#ff6b6b;
    --grid:#1b283a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .app{display:flex;flex-direction:column;height:100%;}
  .topbar{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;padding:.5rem .75rem .25rem;}
  .chip{background:var(--chip);border-radius:12px;padding:.35rem .6rem;font-weight:600;color:var(--fg);box-shadow:0 0 0 1px rgba(255,255,255,.05) inset}
  .legend{display:flex;gap:1rem;align-items:center;flex:1;flex-wrap:wrap}
  .dot{display:inline-block;width:.6rem;height:.6rem;border-radius:50%;margin-right:.35rem;vertical-align:-1px}
  .btn{background:var(--chip);color:var(--fg);border:none;border-radius:12px;padding:.45rem .7rem;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .canvasWrap{position:relative;flex:1;min-height:200px;padding:0 .5rem .25rem}
  canvas{display:block;width:100%;height:100%;border-radius:14px;background:
    radial-gradient(circle at 50% 50%, rgba(255,255,255,.02), transparent 60%),
    linear-gradient(transparent 39px, var(--grid) 40px),
    linear-gradient(90deg, transparent 39px, var(--grid) 40px),
    var(--panel);
    background-size:100% 100%, 40px 40px, 40px 40px, auto;
  }
  .controls{display:grid;gap:.75rem;grid-template-columns:repeat(6, minmax(200px,1fr));padding:.6rem}
  @media (max-width:1200px){
    .controls{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:700px){
    .controls{grid-template-columns:1fr}
  }
  .ctl{background:var(--panel);border-radius:14px;padding:.8rem}
  .ctl h4{margin:.1rem 0 .4rem;font-size:.95rem;color:var(--muted);font-weight:700}
  .row{display:flex;gap:.8rem;align-items:center}
  input[type=range]{width:100%}
  .val{width:3.6rem;text-align:right;font-variant-numeric:tabular-nums;font-weight:800}
  .note{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <span class="chip">G <span id="gval">0</span></span>
    <span class="chip">K(P₀) <span id="kP0">0</span></span>
    <span class="chip">ΔK(L) <span id="dkL">0</span></span>
    <span class="chip" id="decision">決策：—</span>
    <div class="legend" id="legend">
      <span class="chip"><span class="dot" style="background:#ff5c5c"></span>M1 原料1</span>
      <span class="chip"><span class="dot" style="background:#37d3e6"></span>M2 原料2</span>
      <span class="chip"><span class="dot" style="background:#35e17a"></span>K 消費地</span>
      <span class="chip"><span class="dot" style="background:#ffa62b"></span>L 勞動地</span>
      <span class="chip"><span class="dot" style="background:transparent;border:2px dashed var(--warn);width:.8rem;height:.8rem"></span>臨界等費線 ΔK=S</span>
    </div>
    <button class="btn" id="toggleIso">顯示/隱藏 臨界等費線</button>
  </div>

  <div class="canvasWrap"><canvas id="c"></canvas></div>

  <div class="controls">
    <div class="ctl">
      <h4>原料1權重 w1</h4>
      <div class="row">
        <input id="w1" type="range" min="0" max="5" step="0.1" value="1"/>
        <div class="val" id="w1v">1.0</div>
      </div>
    </div>
    <div class="ctl">
      <h4>原料2權重 w2</h4>
      <div class="row">
        <input id="w2" type="range" min="0" max="5" step="0.1" value="1.5"/>
        <div class="val" id="w2v">1.5</div>
      </div>
    </div>
    <div class="ctl">
      <h4>消費地權重 wK</h4>
      <div class="row">
        <input id="wK" type="range" min="0" max="5" step="0.1" value="1"/>
        <div class="val" id="wKv">1.0</div>
      </div>
    </div>
    <div class="ctl">
      <h4>費率 As（噸公里成本）</h4>
      <div class="row">
        <input id="as" type="range" min="0.2" max="3" step="0.05" value="1.0"/>
        <div class="val" id="asv">1.00</div>
      </div>
    </div>
    <div class="ctl">
      <h4>勞動節約 S（每單位）</h4>
      <div class="row">
        <!-- 唯一修改：max="40" -->
        <input id="S" type="range" min="0" max="40" step="0.01" value="0.8"/>
        <div class="val" id="Sv">0.80</div>
      </div>
      <div class="note">正統規則：若 <b>S ≥ ΔK(L)</b>，工廠搬到 L；否則留在 P₀。</div>
    </div>
    <div class="ctl">
      <h4>縮放 Zoom</h4>
      <div class="row">
        <input id="zoom" type="range" min="0.2" max="10" step="0.05" value="0.9"/>
        <div class="val" id="zoomv">0.90</div>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha: true });
let W=0,H=0, DPR = Math.max(1, devicePixelRatio || 1);
let zoom = +document.getElementById('zoom').value;

const colors = {
  M1:'#ff5c5c',
  M2:'#37d3e6',
  K :'#35e17a',
  L :'#ffa62b',
  P :'#ffffff',
  iso:'#ffc857'
};

const UI = {
  w1: document.getElementById('w1'),
  w2: document.getElementById('w2'),
  wK: document.getElementById('wK'),
  as: document.getElementById('as'),
  S : document.getElementById('S'),
  zoom: document.getElementById('zoom'),
  w1v: document.getElementById('w1v'),
  w2v: document.getElementById('w2v'),
  wKv: document.getElementById('wKv'),
  asv: document.getElementById('asv'),
  Sv : document.getElementById('Sv'),
  zoomv: document.getElementById('zoomv'),
  gval: document.getElementById('gval'),
  kP0 : document.getElementById('kP0'),
  dkL : document.getElementById('dkL'),
  decision: document.getElementById('decision'),
  toggleIso: document.getElementById('toggleIso')
};

let showIso = false;

const Pts = {
  M1: {x:-300, y:-150, key:'M1'},
  M2: {x: 300, y:-150, key:'M2'},
  K : {x:   40, y: 220, key:'K'  },
  L : {x:-160, y: 180, key:'L'  }
};

function resize(){
  const rect = canvas.parentElement.getBoundingClientRect();
  W = Math.floor(rect.width);
  H = Math.floor(rect.height);
  canvas.width = Math.floor(W*DPR);
  canvas.height= Math.floor(H*DPR);
  canvas.style.width = W+'px';
  canvas.style.height= H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw();
}
addEventListener('resize', resize, {passive:true});
resize();

function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function Kcost(P){
  const w1=+UI.w1.value, w2=+UI.w2.value, wK=+UI.wK.value, As=+UI.as.value;
  return As*( w1*dist(P, Pts.M1) + w2*dist(P, Pts.M2) + wK*dist(P, Pts.K) );
}
function weiszfeld(){
  const w1=+UI.w1.value, w2=+UI.w2.value, wK=+UI.wK.value;
  let p = {x:(Pts.M1.x+Pts.M2.x+Pts.K.x)/3, y:(Pts.M1.y+Pts.M2.y+Pts.K.y)/3};
  for(let it=0; it<100; it++){
    const d1 = Math.max(1e-6, dist(p, Pts.M1));
    const d2 = Math.max(1e-6, dist(p, Pts.M2));
    const dK = Math.max(1e-6, dist(p, Pts.K ));
    const numx = w1*Pts.M1.x/d1 + w2*Pts.M2.x/d2 + wK*Pts.K.x/dK;
    const numy = w1*Pts.M1.y/d1 + w2*Pts.M2.y/d2 + wK*Pts.K.y/dK;
    const den  = w1/d1 + w2/d2 + wK/dK;
    const nx = numx/den, ny=numy/den;
    if (Math.hypot(nx-p.x, ny-p.y) < 1e-4) { p.x=nx; p.y=ny; break; }
    p.x=nx; p.y=ny;
  }
  return p;
}
function deltaKAt(P, P0){ return Kcost(P) - Kcost(P0); }

function buildIso(P0, S){
  const pts = [];
  const maxR = 4000;
  const steps = 144;
  for(let i=0;i<steps;i++){
    const ang = (i/steps)*Math.PI*2;
    let lo=0, hi=maxR, mid, tries=0;
    if (deltaKAt({x:P0.x+hi*Math.cos(ang), y:P0.y+hi*Math.sin(ang)}, P0) < S) continue;
    while(hi-lo>1e-2 && tries++<40){
      mid=(lo+hi)/2;
      const P={x:P0.x+mid*Math.cos(ang), y:P0.y+mid*Math.sin(ang)};
      const d=deltaKAt(P,P0);
      if(d>=S) hi=mid; else lo=mid;
    }
    const r=hi;
    pts.push({x:P0.x+r*Math.cos(ang), y:P0.y+r*Math.sin(ang)});
  }
  return pts;
}

let dragKey=null;
function pick(mx,my){
  const p = scr2log({x:mx,y:my});
  const order=['M1','M2','K','L'];
  let found=null, best=1e9;
  for(const k of order){
    const d=dist(p, Pts[k]);
    if(d<18/zoom && d<best){best=d;found=k;}
  }
  return found;
}
function onDown(e){
  const t = e.touches? e.touches[0]: e;
  dragKey = pick(t.clientX, t.clientY);
}
function onMove(e){
  if(!dragKey) return;
  const t = e.touches? e.touches[0]: e;
  const p = scr2log({x:t.clientX, y:t.clientY});
  Pts[dragKey].x = p.x;
  Pts[dragKey].y = p.y;
  draw();
}
function onUp(){ dragKey=null; }
canvas.addEventListener('mousedown', onDown);
canvas.addEventListener('mousemove', onMove);
addEventListener('mouseup', onUp);
canvas.addEventListener('touchstart', onDown, {passive:true});
canvas.addEventListener('touchmove', onMove, {passive:true});
addEventListener('touchend', onUp);

function log2scr(p){ return { x: W/2 + p.x*zoom, y: H/2 + p.y*zoom }; }
function scr2log(p){ return { x: (p.x - W/2)/zoom, y: (p.y - H/2)/zoom }; }

function dot(p, color, r=6){
  const s = log2scr(p);
  ctx.beginPath();
  ctx.arc(s.x, s.y, r, 0, Math.PI*2);
  ctx.fillStyle = color;
  ctx.fill();
}
function seg(a,b, color, w=2, alpha=0.35){
  const A=log2scr(a), B=log2scr(b);
  ctx.strokeStyle = color;
  ctx.globalAlpha = alpha;
  ctx.lineWidth = w;
  ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
  ctx.globalAlpha = 1;
}
function label(p, text, color){
  const s = log2scr(p);
  ctx.font = '12px system-ui, -apple-system, "Noto Sans TC"';
  ctx.fillStyle = color;
  ctx.fillText(text, s.x+8, s.y-8);
}
function drawIsoCurve(P0,S){
  if(!showIso) return;
  const iso = buildIso(P0, S);
  if(!iso.length) return;
  ctx.setLineDash([6,6]);
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#ffc857';
  ctx.beginPath();
  const s0=log2scr(iso[0]); ctx.moveTo(s0.x, s0.y);
  for(let i=1;i<iso.length;i++){ const s=log2scr(iso[i]); ctx.lineTo(s.x,s.y); }
  ctx.closePath(); ctx.stroke();
  ctx.setLineDash([]);
}
function draw(){
  zoom = +UI.zoom.value;
  ctx.clearRect(0,0,W,H);

  const P0 = weiszfeld();
  const Sval = +UI.S.value;
  const dKL = deltaKAt(Pts.L, P0);
  const moveToL = (Sval >= dKL - 1e-9);
  const Pcur = moveToL ? Pts.L : P0;

  drawIsoCurve(P0, Sval);

  seg(Pcur, Pts.M1, colors.M1, 2.5);
  seg(Pcur, Pts.M2, colors.M2, 2.5);
  seg(Pcur, Pts.K , colors.K , 2.5);

  dot(Pts.M1, colors.M1, 6); label(Pts.M1,'M1',colors.M1);
  dot(Pts.M2, colors.M2, 6); label(Pts.M2,'M2',colors.M2);
  dot(Pts.K , colors.K ,  6); label(Pts.K ,'K',  colors.K );
  dot(Pts.L , colors.L ,  6); label(Pts.L ,'L',  colors.L );
  dot(Pcur, colors.P, 7); label(Pcur, 'P', colors.P);

  UI.w1v.textContent = (+UI.w1.value).toFixed(1);
  UI.w2v.textContent = (+UI.w2.value).toFixed(1);
  UI.wKv.textContent = (+UI.wK.value).toFixed(1);
  UI.asv.textContent = (+UI.as.value).toFixed(2);
  UI.Sv .textContent = Sval.toFixed(2);
  UI.zoomv.textContent = (+UI.zoom.value).toFixed(2);

  const G = (+UI.w1.value) + (+UI.w2.value) + (+UI.wK.value);
  document.getElementById('gval').textContent = G.toFixed(2);
  document.getElementById('kP0').textContent = Kcost(P0).toFixed(1);
  document.getElementById('dkL').textContent = dKL.toFixed(1);
  const dec = document.getElementById('decision');
  dec.textContent = '決策：' + (moveToL ? '移至 L' : '留在 P₀');
  dec.style.background = moveToL ? 'var(--good)' : 'var(--chip)';
  dec.style.color = moveToL ? '#00170b' : 'var(--fg)';
}

['w1','w2','wK','as','S','zoom'].forEach(id=>{
  UI[id].addEventListener('input', draw, {passive:true});
});
UI.toggleIso.addEventListener('click', ()=>{ showIso = !showIso; draw(); });

})();
</script>
</body>
</html>
