<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>韋伯工業區位理論｜互動教學（手機優化）</title>
<style>
  :root{ --bg:#0b1020; --panel:#111831; --ink:#e8eefc; --muted:#9fb0d7; --accent:#ffd166;
         --m1:#ef4444; --m2:#06b6d4; --k:#22c55e; --l:#f59e0b; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
            font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
  .wrap{display:flex;flex-direction:column;min-height:100dvh}
  #stage{position:relative;width:100%;aspect-ratio:1170/700;max-height:60vh;border-bottom:1px solid rgba(255,255,255,.08)}
  canvas{display:block;width:100%;height:100%}
  .toolbar{position:absolute;left:8px;top:8px;display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);
        padding:6px 10px;border-radius:999px;font-size:12px}
  .legend{position:absolute;right:8px;top:8px;background:rgba(10,12,18,.75);backdrop-filter:blur(4px);
          border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px 10px;font-size:12px}
  .legend i{display:inline-block;width:10px;height:10px;margin-right:6px;border-radius:50%}
  .legend .m1{background:#ef4444}.legend .m2{background:#06b6d4}.legend .k{background:#22c55e}.legend .l{background:#f59e0b}
  .legend .iso{display:inline-block;width:18px;height:0;border-top:2px dashed var(--accent)}
  .controls{padding:10px 12px;background:var(--panel)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .ctrl{background:#0f1734;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .ctrl label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;color:var(--muted)}
  .ctrl input[type=range]{width:100%}
  .row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.15);background:#0f1630;color:var(--ink);
       padding:6px 10px;border-radius:10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--panel);
         border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -10px 20px rgba(0,0,0,.35);
         transform:translateY(65%);transition:transform .25s ease;z-index:20}
  .sheet .handle{width:42px;height:5px;border-radius:999px;background:rgba(255,255,255,.2);margin:8px auto}
  .sheet .content{max-height:46vh;overflow:auto;padding:0 14px 16px}
  .sheet h2{font-size:15px;margin:8px 0 4px;color:var(--accent)}
  .sheet p,.sheet li{font-size:14px;color:#d6ddf5}
  .sheet.open{transform:translateY(0);pointer-events:auto}
  .sheet.closed{pointer-events:none}
  @media (min-width:900px){
    #stage{max-height:66vh}
    .grid{grid-template-columns:repeat(4,1fr)}
    .sheet .content{max-height:52vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <section id="stage">
    <canvas id="cv" aria-label="Weber 模型互動畫布"></canvas>
    <div class="toolbar" id="chips"></div>
    <div class="legend">
      <div><i class="m1"></i>M1 原料1</div>
      <div><i class="m2"></i>M2 原料2</div>
      <div><i class="k"></i>K 消費地</div>
      <div><i class="l"></i>L 勞動地</div>
      <div style="margin-top:6px"><span class="iso"></span> 臨界等費線 ΔK=S</div>
    </div>
  </section>

  <section class="controls">
    <div class="grid">
      <div class="ctrl"><label>原料1權重 w1 <b id="w1v"></b></label><input id="w1" type="range" min="0" max="10" step="0.5" value="1"></div>
      <div class="ctrl"><label>原料2權重 w2 <b id="w2v"></b></label><input id="w2" type="range" min="0" max="10" step="0.5" value="1"></div>
      <div class="ctrl"><label>消費地權重 wK <b id="w3v"></b></label><input id="w3" type="range" min="0" max="10" step="0.5" value="1"></div>
      <div class="ctrl"><label>費率 As（噸公里成本） <b id="asv"></b></label><input id="as" type="range" min="0.5" max="5" step="0.1" value="1"></div>
      <div class="ctrl"><label>勞動節約 S（相對刻度） <b id="sv"></b></label><input id="srel" type="range" min="0" max="100" step="1" value="20"></div>
      <div class="ctrl"><label>縮放 Zoom <b id="zoomv"></b></label><input id="zoom" type="range" min="0.6" max="1.6" step="0.05" value="0.85"></div>
      <div class="row">
        <button class="btn" id="btnIso">顯示/隱藏 臨界等費線</button>
        <button class="btn" id="btnHeat">顯示/隱藏 ΔK 熱度</button>
        <button class="btn" id="btnHelp">說明</button>
      </div>
    </div>
  </section>
</div>

<section class="sheet closed" id="sheet">
  <div class="handle" id="handle"></div>
  <div class="content">
    <h2>怎麼讀這個圖？</h2>
    <p>紅 <b>M1</b>、藍 <b>M2</b>、綠 <b>K</b> 是兩種原料與消費地；白 <b>P₀</b> 是只看運輸成本的最小點；若把 <b>L</b> 拖進臨界線內且 <code>ΔK(L) ≤ S</code>，工廠就會搬到 <b>L</b>。</p>
    <ul>
      <li>黑雲：<code>ΔK(x)=K(x)-K(P₀)</code>，越黑＝偏離成本越高。</li>
      <li>黃虛線：<b>臨界等費線</b>，滿足 <code>ΔK=S</code>。把 <b>L</b> 拖進圈 ⇒ 會搬；拖到圈外 ⇒ 不搬。</li>
      <li>S 為相對刻度（依當前畫面自動換算），避免臨界圈超出畫面。</li>
    </ul>
    <h2>As 與 S 如何影響？</h2>
    <ul>
      <li><b>As ↑</b>：每公里更貴 → ΔK 上升更快 → 圈縮小 → 較難搬。</li>
      <li><b>S ↑</b>：勞動節約變大 → 圈放大 → 較易搬。</li>
    </ul>
  </div>
</section>

<script>
(function(){
  'use strict';
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  let DPR = Math.max(1, window.devicePixelRatio||1);

  const view = { z: 0.85 };

  const $ = id => document.getElementById(id);
  const w1=$('w1'), w2=$('w2'), w3=$('w3'), as=$('as'), srel=$('srel'), zoom=$('zoom');
  const w1v=$('w1v'), w2v=$('w2v'), w3v=$('w3v'), asv=$('asv'), sv=$('sv'), zoomv=$('zoomv');
  const chips = $('chips');
  const btnIso = $('btnIso'), btnHeat = $('btnHeat'), btnHelp = $('btnHelp');

  const sheet = $('sheet'), handle=$('handle');
  const setSheetOpen = (open)=>{ sheet.classList.toggle('open',open); sheet.classList.toggle('closed',!open); };
  setSheetOpen(false);
  handle.addEventListener('click', ()=>setSheetOpen(!sheet.classList.contains('open')));

  const Pts = {
    M1:{x:420,y:220,w:1,color:'#ef4444'},
    M2:{x:850,y:240,w:1,color:'#06b6d4'},
    K :{x:600,y:480,w:1,color:'#22c55e'},
    L :{x:760,y:420,w:1,color:'#f59e0b'}
  };

  function resize(){
    const r = cv.parentElement.getBoundingClientRect();
    DPR = Math.max(1, window.devicePixelRatio||1);
    cv.width = Math.round(r.width * DPR);
    cv.height= Math.round(r.height* DPR);
    cv.style.width  = r.width+'px';
    cv.style.height = r.height+'px';
    draw();
  }
  window.addEventListener('resize', resize, {passive:true});

  const H = Math.hypot;
  function Kcost(p){
    const A = +as.value;
    const {M1,M2,K} = Pts;
    return A*(M1.w*H(p.x-M1.x,p.y-M1.y) + M2.w*H(p.x-M2.x,p.y-M2.y) + K.w*H(p.x-K.x,p.y-K.y));
  }
  function deltaK(p, p0){ return Math.max(0, Kcost(p)-Kcost(p0)); }

  function P0(){
    const {M1,M2,K}=Pts; const pts=[M1,M2,K];
    let x=(M1.x+M2.x+K.x)/3, y=(M1.y+M2.y+K.y)/3;
    for(let i=0;i<80;i++){
      let nx=0,ny=0,den=0;
      for(const q of pts){ const dx=x-q.x, dy=y-q.y, d=H(dx,dy)||1e-6, w=q.w/d; nx+=w*q.x; ny+=w*q.y; den+=w; }
      const xx=nx/den, yy=ny/den; if(H(xx-x,yy-y)<0.1){x=xx; y=yy; break;} x=xx; y=yy;
    }
    return {x,y};
  }

  let deltaMax = 100;
  let showIso=true, showHeat=true;

  function drawHeat(p0){
    if(!showHeat) return;
    const step = Math.max(8, Math.round(Math.min(cv.width,cv.height)/90));
    deltaMax=0;
    for(let y=0;y<cv.height;y+=step)for(let x=0;x<cv.width;x+=step){
      const dk = deltaK(toWorld({x,y}), p0); if(dk>deltaMax) deltaMax=dk;
    }
    deltaMax=Math.max(1,deltaMax);
    ctx.save();
    for(let y=0;y<cv.height;y+=step)for(let x=0;x<cv.width;x+=step){
      const dk = deltaK(toWorld({x,y}), p0);
      let a = Math.min(1, dk/(0.9*deltaMax)); a = Math.pow(a,0.7);
      ctx.fillStyle=`rgba(0,0,0,${a*0.45})`; ctx.fillRect(x,y,step,step);
    }
    ctx.restore();
  }
  function drawIso(p0){
    if(!showIso){ sv.textContent = `${srel.value}%`; return {inside:false,S:0}; }
    const S = 0.9*deltaMax*(+srel.value)/100;
    sv.textContent = `${srel.value}%（實際ΔK≈${S.toFixed(1)}）`;
    const MAXR = Math.hypot(cv.width,cv.height);
    const poly=[];
    for(let ang=0; ang<360; ang+=2){
      const th=ang*Math.PI/180; let lo=0, hi=MAXR, found=null;
      for(let t=0;t<18;t++){
        const mid=(lo+hi)/2, sx=p0.x+Math.cos(th)*mid, sy=p0.y+Math.sin(th)*mid;
        if(sx<0||sx>cv.width||sy<0||sy>cv.height){ hi=mid; continue; }
        const d=deltaK(toWorld({x:sx,y:sy}), p0)-S;
        if(Math.abs(d)<0.5){ found={x:sx,y:sy}; break; }
        (d>0)? hi=mid : lo=mid;
      }
      if(found) poly.push(found);
    }
    if(poly.length>2){
      ctx.save(); ctx.strokeStyle='rgba(255,208,102,.95)'; ctx.setLineDash([8,6]); ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(poly[0].x,poly[0].y); for(let i=1;i<poly.length;i++) ctx.lineTo(poly[i].x,poly[i].y);
      ctx.closePath(); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
    }
    return { inside: pointInPolygon(toScreen(Pts.L), poly), S };
  }
  function pointInPolygon(pt, poly){
    if(!poly||poly.length<3) return false; let inside=false;
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      const xi=poly[i].x,yi=poly[i].y,xj=poly[j].x,yj=poly[j].y;
      const inter=((yi>pt.y)!=(yj>pt.y))&&(pt.x < (xj-xi)*(pt.y-yi)/(yj-yi+1e-9)+xi);
      if(inter) inside=!inside;
    }
    return inside;
  }

  function toScreen(p){ return {x:p.x*DPR*view.z, y:p.y*DPR*view.z}; }
  function toWorld(p){ return {x:p.x/(DPR*view.z), y:p.y/(DPR*view.z)}; }

  function draw(){
    Pts.M1.w=+w1.value; w1v.textContent=(+w1.value).toFixed(1);
    Pts.M2.w=+w2.value; w2v.textContent=(+w2.value).toFixed(1);
    Pts.K.w =+w3.value; w3v.textContent=(+w3.value).toFixed(1);
    zoomv.textContent = view.z.toFixed(2);
    asv.textContent=(+as.value).toFixed(2);

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.setTransform(DPR*view.z,0,0,DPR*view.z,0,0);

    ctx.strokeStyle='rgba(255,255,255,.05)'; ctx.lineWidth=1/DPR;
    ctx.beginPath(); const gh=32; 
    for(let x=0;x<cv.width/(DPR*view.z);x+=gh){ctx.moveTo(x,0);ctx.lineTo(x,cv.height/(DPR*view.z));}
    for(let y=0;y<cv.height/(DPR*view.z);y+=gh){ctx.moveTo(0,y);ctx.lineTo(cv.width/(DPR*view.z),y);} 
    ctx.stroke();

    const p0 = P0();
    drawHeat(p0);
    const iso=drawIso(p0);

    ctx.strokeStyle='rgba(59,130,246,.9)'; ctx.lineWidth=1.8/DPR;
    ctx.beginPath(); ctx.moveTo(Pts.M1.x,Pts.M1.y); ctx.lineTo(Pts.M2.x,Pts.M2.y); ctx.lineTo(Pts.K.x,Pts.K.y); ctx.closePath(); ctx.stroke();

    drawDot(Pts.M1,'M1', '#ef4444'); drawDot(Pts.M2,'M2', '#06b6d4');
    drawDot(Pts.K ,'K' , '#22c55e'); drawDot(Pts.L ,'L' , '#f59e0b');

    // ==== P（永遠白色）。若決策搬到 L，外圈加金色環 ====
    const moveToL = iso.inside;
    const Pcur = moveToL ? Pts.L : p0;
    // 實心白點
    ctx.fillStyle = '#ffffff';
    ctx.beginPath(); ctx.arc(Pcur.x, Pcur.y, 6, 0, Math.PI*2); ctx.fill();
    // 若搬到 L，用金色細環提示
    if (moveToL){
      ctx.strokeStyle = 'rgba(245,158,11,.9)';
      ctx.lineWidth = 2/DPR;
      ctx.beginPath(); ctx.arc(Pcur.x, Pcur.y, 10, 0, Math.PI*2); ctx.stroke();
    }
    ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.fillText('P', Pcur.x+10, Pcur.y-10);
    // =====================================================

    chips.innerHTML='';
    chip('G', (Pts.M1.w+Pts.M2.w+Pts.K.w).toFixed(2));
    chip('K(P₀)', Kcost(p0).toFixed(1));
    chip('ΔK(L)', deltaK(Pts.L, p0).toFixed(1));
    chip('S(實際)', iso.S.toFixed(1));
    chip('決策', moveToL?'搬去 L':'留在 P₀');
  }
  function chip(label, val){ const d=document.createElement('div'); d.className='chip'; d.innerHTML=`<b>${label}</b> ${val}`; chips.appendChild(d); }

  function drawDot(pt, name, color){
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(pt.x,pt.y,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='12px system-ui'; ctx.fillText(name, pt.x+9, pt.y-9);
  }

  let dragging=null, off={x:0,y:0};
  cv.addEventListener('pointerdown', e=>{
    const p = toWorld(getMouse(e));
    const rad = 14/view.z;
    for(const k of ['M1','M2','K','L']){
      const q=Pts[k]; if(H(p.x-q.x,p.y-q.y) < rad){ dragging=k; off={x:p.x-q.x,y:p.y-q.y}; break; }
    }
    if(dragging) cv.setPointerCapture(e.pointerId);
  });
  cv.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const p = toWorld(getMouse(e)); const q = Pts[dragging];
    q.x = p.x - off.x; q.y = p.y - off.y; draw();
  });
  cv.addEventListener('pointerup', ()=>{ dragging=null; });

  function getMouse(e){ const r=cv.getBoundingClientRect(); return {x:(e.clientX-r.left)*DPR, y:(e.clientY-r.top)*DPR}; }

  const bind = (el, fn)=>{ el.addEventListener('input', fn); el.addEventListener('change', fn); };
  [w1,w2,w3,as,srel].forEach(el=>bind(el, draw));
  bind(zoom, ()=>{ view.z = +zoom.value; draw(); });
  btnIso.addEventListener('click', ()=>{ showIso=!showIso; draw(); });
  btnHeat.addEventListener('click', ()=>{ showHeat=!showHeat; draw(); });
  btnHelp.addEventListener('click', ()=> setSheetOpen(!sheet.classList.contains('open')) );

  resize();
})();
</script>
</body>
</html>
